<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Dashboard - Live</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    
    <style>
        :root { --bg: #0d0d0d; --card: #1c1c1e; --text: #fff; --sub: #8e8e93; --green: #00e676; --red: #ff3b30; --orange: #ff4500; --blue: #0a84ff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: background 0.5s; }
        
        /* STATUS CARD */
        .status-card { background: var(--card); border-radius: 24px; padding: 30px 20px; text-align: center; width: 100%; max-width: 400px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .icon-circle { width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05); }
        .status-title { font-size: 2rem; font-weight: 900; margin: 0; letter-spacing: 1px; }
        .status-sub { color: var(--sub); margin-top: 8px; font-size: 1rem; }
        
        /* MAPS & BUTTONS */
        #map-frame { width: 100%; height: 250px; border: none; border-radius: 15px; background: #333; margin-bottom: 15px; }
        .btn-container { display: flex; gap: 10px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .btn { flex: 1; padding: 15px; border-radius: 16px; text-align: center; font-weight: bold; text-decoration: none; display: flex; justify-content: center; align-items: center; color: white; }
        .btn-emergency { background: linear-gradient(90deg, #ff4500, #ff2400); }
        .btn-map { background: var(--card); border: 1px solid #333; color: var(--blue); }

        /* DATA GRID */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .data-card { background: var(--card); border-radius: 16px; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .data-label { color: var(--sub); font-size: 0.8rem; margin-bottom: 5px; }
        .data-value { font-size: 1.1rem; font-weight: bold; }
        
        /* EMERGENCY STATE */
        body.emergency { background: #2a0000; }
        body.emergency .status-card { border: 2px solid var(--red); animation: pulse 1s infinite; }
        body.emergency .status-title { color: var(--red); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }
        
        svg { width: 40px; height: 40px; fill: var(--sub); }
        body.safe .status-title { color: var(--green); }
        body.safe svg { fill: var(--green); }
    </style>
</head>
<body class="safe">

    <div class="status-card">
        <div class="icon-circle" id="status-icon">
            <svg viewBox="0 0 24 24" id="svg-icon"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
        </div>
        <h1 class="status-title" id="main-status">CONNECTING...</h1>
        <p class="status-sub" id="sub-status">Waiting for Firebase Data</p>
    </div>

    <iframe id="map-frame" src=""></iframe>

    <div class="btn-container">
        <a href="tel:112" class="btn btn-emergency">üìû Call SOS</a>
        <a href="#" target="_blank" class="btn btn-map" id="map-link">üìç Open in Maps</a>
    </div>

    <div class="grid-container">
        <div class="data-card"><span class="data-label">Latitude</span><span class="data-value" id="val-lat">---</span></div>
        <div class="data-card"><span class="data-label">Longitude</span><span class="data-value" id="val-lng">---</span></div>
        <div class="data-card"><span class="data-label">Status</span><span class="data-value" id="val-conn">Offline</span></div>
        <div class="data-card"><span class="data-label">Last Sync</span><span class="data-value" id="val-time">--:--:--</span></div>
    </div>

    <script>
        // --- 1. YOUR FIREBASE CONFIGURATION ---
        // Get this from: Firebase Console > Project Settings > General > Your Apps
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. LIVE DATA LISTENER ---
        // This listens to the "/status" path in your Realtime Database
        db.ref('status').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                updateDashboard(data);
            }
        }, (error) => {
            console.error("Firebase Error:", error);
            document.getElementById('val-conn').innerText = "Auth Error";
        });

        function updateDashboard(data) {
            // Update Text Fields
            document.getElementById('val-lat').innerText = data.lat ? data.lat.toFixed(5) : "0.000";
            document.getElementById('val-lng').innerText = data.lng ? data.lng.toFixed(5) : "0.000";
            document.getElementById('val-time').innerText = new Date().toLocaleTimeString();
            document.getElementById('val-conn').innerText = "Online";
            document.getElementById('val-conn').style.color = "var(--green)";

            // Update Map Links
            const lat = data.lat;
            const lng = data.lng;
            document.getElementById('map-link').href = `https://www.google.com/maps?q=${lat},${lng}`;
            
            // Update Embedded Map (OpenStreetMap)
            const offset = 0.005;
            const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lng-offset},${lat-offset},${lng+offset},${lat+offset}&layer=mapnik&marker=${lat},${lng}`;
            document.getElementById('map-frame').src = mapUrl;

            // Handle SOS State
            const body = document.body;
            const title = document.getElementById('main-status');
            const sub = document.getElementById('sub-status');
            const iconPath = document.querySelector('#svg-icon path');

            if (data.sos === 1) {
                body.className = "emergency";
                title.innerText = "SOS ACTIVE";
                sub.innerText = "Emergency triggered from device!";
                iconPath.setAttribute("d", "M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"); // Warning Triangle
            } else {
                body.className = "safe";
                title.innerText = "SECURE";
                sub.innerText = "Device monitoring active";
                iconPath.setAttribute("d", "M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"); // Shield Icon
            }
        }
    </script>
</body>
</html>
